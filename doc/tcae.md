# Transport Controlled Adaptive Encode (TCAE)

## Introduction

Experiments show that there is a sharp increase in the latency of
packets received by a client when the network throughput drops below the
rate at which the packets are generated by the server. In usage models
such as Network Gaming or Real-time Video streaming, such an increase in
latency implies poor user experience to the point of failure. The
Android and Windows Cloud Gaming solutions (maintained in this repo,
targeted for the latest IntelÂ® Data Center GPU Flex series) are good
examples of a usage model where the user experience is extremely
sensitive to overall latency in the system.

Transport and Content Adaptive Encode (TCAE) feature and the closely
associated Transport Controlled Bitrate Control (TCBRC) are intended to
help mitigate this problem.

### TCBRC

The key idea is that the Bitrate control (BRC) module deployed in the
Intel Media Driver runs in a mode that adjusts bitrate on a per-frame
basis. This feature runs without the need of an expensive "BRC-reset"
that reinitializes the BRC with new configuration parameters to adjust
to the instantaneous network capacity. The app-layer of the SW stack is
expected to provide feedback related to network capacity through the
Device Driver Interface (DDI).

The default Variable BitRate Control mode (VBR) is a more generic
bit-rate control mechanism: It allows for Maximum and Average bitrates
to be specified dynamically (adaptive bitrate feature), but these
parameters adapt relatively slowly across several frames. VBR doesn't
allow frame-specific targets/constraints without a BRC-reset, or in some
cases -- introduction of an IDR frame. In other words, TCBRC offers the
advantage of much faster adaptation to new bit-rate requirements than
VBR and is more suited for a latency-sensitive usage scenario.

### TCAE

The input parameters for TCBRC are expected to be generated by the
application and fed in through the DDI for the Media UMD (or through
OneVPL APIs, which takes care of interfacing the Media UMD). Here, the
customer apps are free to bring in their own IP and implement this in
any suitable manner of their choice. Apps are envisioned to take several
variables into account including network conditions and complexity of
the content in play,and use a suitable algorithm to translate this to
what the UMD expects to enable TCBRC. This process/idea is referred to
as "Transport and Content Adaptive Encode" (TCAE).

Generally speaking, a TCAE implementation at the minimum is expected to
generate a prediction of the frame rate to be delivered by the Encoder
to match the network capability. This can further be extended to take
advantage of more advanced encoding features supported by the Intel
Media Driver SW stack.

## Reference TCAE Implementation

A reference TCAE implementation that generates a target size on a
per-frame basis is provided with the current CG server stacks. The
feature is enabled by default in both the Windows and Android Cloud
Gaming configurations.

### Client App Support

TCAE requires a client application that is capable of generating TCAE
feedback data. The required feedback data needs to be supplied in the
format specified by the pre-defined [Control Protocol for Frame
Stats](control_protocol_spec.rst#framestats/).

-   The critical data to supply is in the [framesize]{.title-ref} and
    [framedelay]{.title-ref} fields of the structure. (The rest can be
    zero)
-   It is the responsibility of the client application to generate
    accurate data that reflects the size and network latency of the
    packets received. At the minimum, both these fields should be
    positive integers.

The default recommended client applications packaged with the Windows
and Android solutions both support this feedback. TCAE is triggered only
after at least one valid packet of this feedback.

### Bandwidth Adaptivity

The core part of the reference TCAE implementation is primarily devised
as a transient response to occasional drops in network bandwidth. This
assumes that the bitrate requested takes into account the capacity of
the network in use.

-   If that isn\'t the case, and the network throughput is consistently
    below the bitrate requested, the transient nature of this response
    can lead to a pattern where the latency is rising and then falling
    in a cycle.

To mitigate against this, the TCAE algorithm also includes an
enhancement to stabilise the bitrate generated to an estimated
averagevalue of the network capacity if such an oscillation observed.
This enhancement is referred to as \"Bandwidth Adaptivity\".

-   Bandwidth adaptivity is enabled by default when TCAE is enabled. To
    disable this enhancement, pls see below section on Control settings.

### Control Settings

The parameters that need to be configured for explicit control on the
server side are listed below for each of the CG stacks.

**Android**

The relevant parameters need to be provided on the ICR Encoder command
line. A sample command line is provided below.

-   `-tcae 1` to enable it, and `-tcae 0` to disable the feature.
    (Enabled by default). Note that `ratectrl` parameter must be set to
    VBR to enable TCAE.
-   `tcae_log_path <path>` to specify a path to generate a TCAE event
    log. More info on this in the section on logging (Disabled by
    default).
-   The `maxrate` parameter needs to be programmed explicitly to specify
    the ideal bitrate that should be used by TCAE. This should be
    greater than the target bitrate (specified by the `-b` option)

<!-- -->

    icr_encoder $i -streaming -res 1280x720 -fr 30 -url irrv:264 -plugin qsv -quality 4 \
    -ratectrl VBR -b 7.5M -maxrate 8M -tcae 1 -hwc_sock /opt/workdir/ipc/hwc-sock -tcae_log_path /home/user/tcaeEvents.log

**Windows**

In Windows, the [config files](../sources/streamer/config/) need to be
updated to capture similar settings.

Select the relevant config file for the use case, and edit each of below
settings as required:

-   `enable-tcae = <true/false>` to enable / disable TCAE. (Enabled by
    default). Note that `video-rc = vbr` is required if TCAE is enabled.
    (Default)
-   `video-specific[b] = <target>` to set TCAE Target bitrate. Note that
    this is also used to set VBR Target bitrate for cases where TCAE is
    not enabled.
-   `netpred-target-delay = <integer>` to configure the target latency
    (in ms) at which TCAE starts suppressing frame size in response.
    Default value = 30. Recommended to leave this unchanged unless for
    experimentation.
-   `netpred-records = <integer>` to configure the number of most recent
    data points that will be factored in determining the target bitrate.
    Default value = 100. Recommended to leave this unchanged unless for
    experimentation.

Event logs in Windows are disabled by default. Set environment variable
`TCAE_LOG_ENABLE=1` to generate logs at `C:\Temp\tcaeLogs_PID.log` (PID
is replaced by the runtime process ID for the TCAE thread).

### Logging and Debug Controls

**Latency Logs**

Logging options are available for developers as a debug feature to study
the results and devise improvements. TCAE logs provide basic capability
to capture the network latency data received from the client application
and the response of the encoder.

The controls to enable logging are provided in the above section on
Control parameters. The logs generated are a time-stamped summary of
relevant events in csv format. Here is a sample output:

    FrameDelay,FrameSize,EncSize,PredSize,Feedback_FrameNumber,EncoderThread_FrameNumber,RelativeTimeStamp,Function
    ...
    11650, 37968, 0, 0, 1, 57, 969578, UpdateClientFeedback
    1295, 3177, 0, 0, 2, 57, 980133, UpdateClientFeedback
    0, 0, 0, 16666, 3, 57, 980994, GetTargetSize
    0, 0, 4072, 16666, 3, 57, 984291, UpdateEncodedSize
    7937, 479, 0, 0, 4, 58, 992027, UpdateClientFeedback
    0, 0, 0, 16666, 5, 58, 997961, GetTargetSize
    0, 0, 3525, 16666, 5, 58, 1001358, UpdateEncodedSize
    ...

These logs are not enabled with VBR. A debug feature is available in
both Windows and Android stacks to generate these latency logs for
VBR(for debug/ comparison vs TCAE).

-   To do this, the encoder needs to be run with TCAE enabled, and in
    addition set an environment variable `BRC_OVERRIDE_MODE=1`. This has
    the effect of running the encoder in VBR mode without TCAE, but
    enables logs for client-reported latency and Encoder response.

**Turn off Bandwidth Adaptivity**

The Bandwidth Adaptivity feature is enabled by default. To disable, the
server app needs to be run with environment variable
`TCAE_STEADY_STATE_CHECK=0`.

**Additional Debug Logging**

Additional logs related to the core part of the algorithm can be enabled
with envrironment variable `TCAE_NETPRED_DUMPS=1`. Note that these are
meant to generate traces to debug problems, and not recommended to be
enabled in normal usage flows.

# Copyright (C) 2020-2023 Intel Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions
# and limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0


# This file is automatically generated from .m4 template.
# To update, modify the template and regenerate.

ARG IMAGE=ubuntu:22.04
FROM $IMAGE AS base

RUN mkdir -p /opt/build && mkdir -p /opt/dist

ENV PKG_CONFIG_PATH=/opt/lib/pkgconfig

RUN apt-get update && \
  DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    git && \
  rm -rf /var/lib/apt/lists/*
# Some operations require configured user
RUN git config --global user.email "someone@somewhere.com" && \
  git config --global user.name "Some One"

RUN apt-get update && \
  DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    gcc \
    g++ \
    git \
    lbzip2 \
    libglib2.0-dev \
    pkg-config \
    python3 \
    python3-setuptools \
    xz-utils && \
  rm -rf /var/lib/apt/lists/*
ARG OWT_GS_REPO=https://github.com/open-webrtc-toolkit/owt-client-native.git
RUN mkdir -p /opt/build/owt-gs && cd /opt/build/owt-gs && \
  git clone $OWT_GS_REPO src && cd src && \
  git checkout 9ec5c2f

ARG DEPOT_TOOLS_REPO=https://chromium.googlesource.com/chromium/tools/depot_tools.git
RUN cd /opt/build/owt-gs && \
  git clone $DEPOT_TOOLS_REPO depot_tools && cd depot_tools && \
  git checkout 5b0c934

RUN mkdir -p /opt/build/owt-gs && { \
  echo "solutions = ["; \
  echo "{"; \
  echo "   \"managed\": False,"; \
  echo "   \"name\": \"src\","; \
  echo "   \"url\": \"https://github.com/open-webrtc-toolkit/owt-client-native.git\","; \
  echo "   \"custom_deps\": {},"; \
  echo "   \"deps_file\": \"DEPS\","; \
  echo "   \"safesync_url\": \"\","; \
  echo "   \"custom_vars\": {\"checkout_instrumented_libraries\": False},"; \
  echo "},"; \
  echo "]"; \
  echo "target_os = []"; \
} > /opt/build/owt-gs/.gclient
RUN { \
  echo "[Boto]"; \
  echo "proxy = $(echo $http_proxy | sed -E "s%http://(.*):(.*)$%\1%")"; \
  echo "proxy_port = $(echo $http_proxy | sed -E "s%http://(.*):(.*)$%\2%")"; \
  echo "https_validate_certificate = True"; \
} > /opt/build/owt-gs/.boto && cat /opt/build/owt-gs/.boto

RUN cd /opt/build/owt-gs && \
  export PATH=/opt/build/owt-gs/depot_tools:$PATH && \
  export NO_AUTH_BOTO_CONFIG=$(pwd)/.boto && \
  export DEPOT_TOOLS_UPDATE=0 && \
  gclient sync --no-history

RUN cd /opt/build/owt-gs/src && mkdir dist && \
  export PATH=/opt/build/owt-gs/depot_tools:$PATH && \
  python3 scripts/build_linux.py --gn_gen --sdk --cloud_gaming --output_path dist \
    --scheme release --arch x64 --use_gcc --shared --fake_audio

RUN cd /opt/build/owt-gs/src && \
  mkdir -p /opt/include && mkdir -p /opt/lib && \
  mkdir -p /opt/dist//opt/include && mkdir -p /opt/dist//opt/lib && \
  cp -rd dist/include /opt && \
  cp -rd dist/include /opt/dist//opt && \
  cp dist/libs/* /opt/lib && \
  cp dist/libs/* /opt/dist//opt/lib

RUN mkdir -p /opt/lib/pkgconfig && { \
  echo "prefix=/opt"; \
  echo "libdir=/opt/lib"; \
  echo "includedir=/opt/include"; \
  echo ""; \
  echo "Name: OWT Game Streaming SDK"; \
  echo "Description: OWT Game Streaming SDK"; \
  echo "Version: 1.0"; \
  echo ""; \
  echo "Libs: -L\${libdir} -lowt"; \
  echo "Cflags: -I\${includedir}"; \
  } > /opt/lib/pkgconfig/owt-gs.pc
RUN mkdir -p /opt/redist/owt//opt/include && \
  mkdir -p /opt/redist/owt//opt/lib/pkgconfig && \
  cd /opt/build/owt-gs/src && \
  cp -rd dist/include /opt/redist/owt//opt && \
  cp dist/libs/* /opt/redist/owt//opt/lib && \
  cp /opt/lib/pkgconfig/owt-gs.pc /opt/redist/owt//opt/lib/pkgconfig/ && \
  cd /opt/redist/ && \
  tar cJvf owt.tar.xz owt

RUN echo "Start cleanup" && \
    rm -rf /opt/dist//opt/share/man && \
    echo "Cleanup done"

WORKDIR /opt/redist
